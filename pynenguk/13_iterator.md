
## Итераторы, итерируемые объекты

* итерируемые объекты (iterable)
* итераторы (iterator)
* генераторные выражения (generator expression)

---
## Итерируемый объект

Итерируемый объект (iterable) - это объект, который способен возвращать
элементы по одному. Кроме того, это объект, из которого можно получить
итератор.

Примеры итерируемых объектов: 

* все последовательности: список, строка, кортеж 
* словари 
* файлы

---
## Итерируемый объект

В Python за получение итератора отвечает функция iter():

```python
In [1]: lista = [1, 2, 3]

In [2]: iter(lista)
Out[2]: <list_iterator at 0xb4ede28c>
```

Функция ``iter()`` отработает на любом объекте, у которого есть метод
``__iter__`` или метод ``__getitem__``.

Метод ``__iter__`` возвращает итератор. Если этого метода нет,
функция iter() проверяет, нет ли метода ``__getitem__`` - метода,
который позволяет получать элементы по индексу.

Если метод ``__getitem__`` есть, возвращается итератор, который
проходится по элементам, используя индекс (начиная с 0).

На практике использование метода ``__getitem__`` означает, что все
последовательности элементов - это итерируемые объекты. Например,
список, кортеж, строка. Хотя у этих типов данных есть и метод
``__iter__``.

---
## Итераторы

Итератор (iterator) - это объект, который возвращает свои элементы по
одному за раз.

С точки зрения Python - это любой объект, у которого есть метод
``__next__``. Этот метод возвращает следующий элемент, если он есть, или
возвращает исключение StopIteration, когда элементы закончились.

Кроме того, итератор запоминает, на каком объекте он остановился в
последнюю итерацию.

В Python у каждого итератора присутствует метод ``__iter__`` - то есть,
любой итератор является итерируемым объектом. Этот метод просто
возвращает сам итератор.

---
## Итераторы

Пример создания итератора из списка:
```python
In [3]: numbers = [1, 2, 3]

In [4]: i = iter(numbers)
```

Теперь можно использовать функцию next(), которая вызывает метод
``__next__``, чтобы взять следующий элемент:

```python
In [5]: next(i)
Out[5]: 1

In [6]: next(i)
Out[6]: 2

In [7]: next(i)
Out[7]: 3

In [8]: next(i)
------------------------------------------------------------
StopIteration              Traceback (most recent call last)
<ipython-input-8-bed2471d02c1> in <module>()
----> 1 next(i)

StopIteration:
```

После того, как элементы закончились, возвращается исключение
StopIteration.

---
## Итераторы

Для того, чтобы итератор снова начал возвращать элементы, его надо
заново создать.

Аналогичные действия выполняются, когда цикл for проходится по списку:

```python
In [9]: for item in numbers:
   ...:     print(item)
   ...:
1
2
3
```

Когда мы перебираем элементы списка, к списку сначала применяется
функция iter(), чтобы создать итератор, а затем вызывается его метод
``__next__`` до тех пор, пока не возникнет исключение StopIteration.

Итераторы полезны тем, что они отдают элементы по одному. Например, при
работе с файлом это полезно тем, что в памяти будет находиться не весь
файл, а только одна строка файла.

---
## Генератор (generator)

Генераторы - это специальная категория функций, который позволяет легко
создавать свои итераторы. В отличие от обычных функций, генератор не
просто возвращает значение и завершает работу, а возвращает итератор,
который отдает элементы по одному.

Обычная функция завершает работу, если: 

* встретилось выражение ``return``
* закончился код функции (это срабатывает как выражение ``return None``) 
* возникло исключение

После выполнения функции управление возвращается, и программа
выполняется дальше. Все аргументы, которые передавались в функцию,
локальные переменные, все это теряется. Остается только результат,
который вернула функция.

Функция может возвращать список элементов, несколько объектов или
возвращать разные результаты в зависимости от аргументов, но она всегда
возвращает какой-то один результат.

Генератор же генерирует значения. При этом значения возвращаются по
запросу, и после возврата одного значения выполнение функции-генератора
приостанавливается до запроса следующего значения. Между запросами
генератор сохраняет свое состояние.

Python позволяет создавать генераторы двумя способами: 

* генераторное выражение 
* функция-генератор

---
## generator expression (генераторное выражение)

Генераторное выражение использует такой же синтаксис, как list
comprehensions, но возвращает итератор, а не список.

Генераторное выражение выглядит точно так же, как list comprehensions,
но используются круглые скобки:

```python
In [1]: genexpr = (x**2 for x in range(10000))

In [2]: genexpr
Out[2]: <generator object <genexpr> at 0xb571ec8c>

In [3]: next(genexpr)
Out[3]: 0

In [4]: next(genexpr)
Out[4]: 1

In [5]: next(genexpr)
Out[5]: 4
```
